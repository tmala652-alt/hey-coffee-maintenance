# Workflow ระบบแจ้งซ่อม Hey! Coffee Maintenance

## สารบัญ
1. [Workflow หลัก: การแจ้งซ่อม](#1-workflow-หลัก-การแจ้งซ่อม)
2. [Workflow SLA](#2-workflow-sla)
3. [Workflow การมอบหมายงาน](#3-workflow-การมอบหมายงาน)
4. [Workflow การหยุดพัก/ดำเนินงานต่อ](#4-workflow-การหยุดพักดำเนินงานต่อ)
5. [Workflow การอนุมัติค่าใช้จ่าย](#5-workflow-การอนุมัติค่าใช้จ่าย)
6. [Workflow ใบเบิกเงิน](#6-workflow-ใบเบิกเงิน)
7. [Workflow การแจ้งเตือน](#7-workflow-การแจ้งเตือน)
8. [Workflow ตารางบำรุงรักษา](#8-workflow-ตารางบำรุงรักษา)
9. [Workflow การตรวจจับปัญหาซ้ำ](#9-workflow-การตรวจจับปัญหาซ้ำ)

---

## 1. Workflow หลัก: การแจ้งซ่อม

### 1.1 แผนภาพ Status Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                     MAINTENANCE REQUEST WORKFLOW                 │
└─────────────────────────────────────────────────────────────────┘

     ┌──────────┐
     │  สร้าง   │  พนักงานสาขาแจ้งซ่อม
     │  คำขอ    │
     └────┬─────┘
          │
          ▼
    ┌──────────┐         ┌──────────┐
    │ PENDING  │────────▶│ CANCELLED│
    │ รอดำเนินการ│  ยกเลิก  │  ยกเลิก   │
    └────┬─────┘         └──────────┘
          │
          │ มอบหมายช่าง/ผู้รับเหมา
          ▼
    ┌──────────┐
    │ ASSIGNED │
    │ มอบหมายแล้ว│
    └────┬─────┘
          │
          │ ช่างเริ่มงาน
          ▼
    ┌──────────┐
    │IN_PROGRESS│◄────────┐
    │กำลังดำเนินการ│         │
    └────┬─────┘         │
          │              │
          │──────────────┘
          │  หยุดพัก/ดำเนินต่อ
          │
          │ ซ่อมเสร็จ
          ▼
    ┌──────────┐
    │COMPLETED │
    │  เสร็จสิ้น │
    └──────────┘
```

### 1.2 รายละเอียดแต่ละสถานะ

| สถานะ | รหัส | คำอธิบาย | ผู้รับผิดชอบ |
|-------|------|----------|-------------|
| รอดำเนินการ | `pending` | งานใหม่ รอมอบหมาย | Admin |
| มอบหมายแล้ว | `assigned` | มอบหมายช่างแล้ว รอเริ่มงาน | ช่าง |
| กำลังดำเนินการ | `in_progress` | ช่างกำลังซ่อม | ช่าง |
| เสร็จสิ้น | `completed` | ซ่อมเสร็จแล้ว | - |
| ยกเลิก | `cancelled` | ยกเลิกงาน | Admin |

### 1.3 ขั้นตอนโดยละเอียด

#### ขั้นตอนที่ 1: การสร้างคำขอ
```
พนักงานสาขา
    │
    ├── กรอกข้อมูล:
    │   ├── หัวข้อ
    │   ├── รายละเอียด
    │   ├── ประเภท
    │   ├── ความสำคัญ
    │   ├── SLA
    │   └── แนบรูป/วิดีโอ
    │
    └── ส่งคำขอ
         │
         ├── ระบบบันทึกข้อมูล
         ├── คำนวณ due_at ตาม SLA
         ├── สร้าง status_log
         └── แจ้งเตือน Admin
```

#### ขั้นตอนที่ 2: การมอบหมายงาน
```
Admin
    │
    ├── ตรวจสอบคำขอ
    │
    ├── เลือกวิธีมอบหมาย:
    │   ├── อัตโนมัติ (Auto-Assign)
    │   │   ├── skill_match
    │   │   ├── least_loaded
    │   │   └── round_robin
    │   │
    │   └── Manual
    │       └── เลือกช่างเอง
    │
    └── ยืนยันมอบหมาย
         │
         ├── อัปเดต assigned_user_id
         ├── บันทึก assigned_at
         ├── สถานะ → assigned
         ├── เพิ่ม current_workload ช่าง
         └── แจ้งเตือนช่าง
```

#### ขั้นตอนที่ 3: การดำเนินงาน
```
ช่าง
    │
    ├── รับทราบงาน
    │
    ├── เริ่มงาน
    │   ├── สถานะ → in_progress
    │   └── บันทึก status_log
    │
    ├── ระหว่างทำงาน:
    │   ├── อัปเดตความคืบหน้า
    │   ├── แชทกับผู้แจ้ง
    │   ├── หยุดพัก (ถ้าจำเป็น)
    │   └── บันทึกค่าใช้จ่าย
    │
    └── เสร็จงาน
         │
         ├── สถานะ → completed
         ├── บันทึก completed_at
         ├── ลด current_workload
         └── แจ้งเตือนผู้แจ้ง (ขอ Feedback)
```

---

## 2. Workflow SLA

### 2.1 การคำนวณ SLA

```
┌─────────────────────────────────────────────────────────────────┐
│                        SLA CALCULATION                          │
└─────────────────────────────────────────────────────────────────┘

สร้างคำขอ
    │
    ├── โหมด: Calendar
    │   │
    │   └── due_at = created_at + sla_hours
    │       (นับต่อเนื่อง 24 ชม.)
    │
    └── โหมด: Working Hours
        │
        ├── ดึงเวลาทำการสาขา
        ├── ดึงวันหยุด
        │
        └── คำนวณ:
            ├── ข้ามนอกเวลาทำการ
            ├── ข้ามวันหยุด
            └── due_at = เวลาที่นับครบ sla_hours
```

### 2.2 SLA Status Progression

```
เวลาที่ใช้
    │
    ├── 0-74%   → ON_TRACK    🟢 ปกติ
    │
    ├── 75-89%  → WARNING     🟡 เตือน
    │               └── แจ้งเตือนช่าง
    │
    ├── 90-99%  → CRITICAL    🟠 วิกฤต
    │               └── แจ้งเตือน Admin + ช่าง
    │
    └── 100%+   → BREACHED    🔴 เกินกำหนด
                    └── แจ้งเตือนทุกคนที่เกี่ยวข้อง
```

### 2.3 SLA Escalation Rules

```
┌─────────────────────────────────────────────────────────────────┐
│                     SLA ESCALATION FLOW                         │
└─────────────────────────────────────────────────────────────────┘

ตรวจสอบทุกงาน (scheduled job)
    │
    ├── งานยังไม่เสร็จ?
    │   │
    │   ├── คำนวณ % elapsed
    │   │
    │   └── ตรวจสอบ threshold:
    │       │
    │       ├── >= 75% (Warning)
    │       │   └── notify: assigned_user
    │       │
    │       ├── >= 90% (Critical)
    │       │   └── notify: assigned_user, admin
    │       │
    │       └── >= 100% (Breached)
    │           └── notify: assigned_user, admin, manager
    │
    └── ไม่ต้องทำอะไร
```

---

## 3. Workflow การมอบหมายงาน

### 3.1 Auto-Assignment Algorithm

```
┌─────────────────────────────────────────────────────────────────┐
│                    AUTO-ASSIGNMENT FLOW                         │
└─────────────────────────────────────────────────────────────────┘

คำขอ (pending)
    │
    ├── ตรวจสอบ Assignment Rules
    │   │
    │   ├── ถ้ามี rule ตรง:
    │   │   └── ใช้ strategy ของ rule นั้น
    │   │
    │   └── ถ้าไม่มี:
    │       └── ใช้ default strategy (skill_match)
    │
    ├── คำนวณคะแนนช่างแต่ละคน
    │   │
    │   ├── Skill Score (0-1)
    │   │   └── ทักษะตรงกับ category
    │   │
    │   ├── Workload Score (0-1)
    │   │   └── current / max workload
    │   │
    │   └── Availability Score (0-1)
    │       └── ว่างวันนี้หรือไม่
    │
    ├── น้ำหนักตาม Strategy:
    │   │
    │   ├── skill_match:
    │   │   └── 50% skill + 30% workload + 20% availability
    │   │
    │   ├── least_loaded:
    │   │   └── 20% skill + 60% workload + 20% availability
    │   │
    │   └── round_robin:
    │       └── 0% skill + 50% workload + 50% availability
    │
    └── เลือกช่างที่คะแนนสูงสุด
        │
        └── มอบหมาย + แจ้งเตือน
```

### 3.2 Manual Assignment

```
Admin
    │
    ├── เปิดหน้ารายละเอียดงาน
    │
    ├── คลิก "มอบหมายงาน"
    │
    ├── ดูรายการช่าง:
    │   ├── ชื่อ
    │   ├── ทักษะ
    │   ├── งานปัจจุบัน
    │   └── ความพร้อม
    │
    ├── เลือกช่าง
    │
    └── ยืนยัน
         │
         ├── อัปเดต request
         ├── เพิ่ม workload ช่าง
         └── แจ้งเตือนช่าง
```

---

## 4. Workflow การหยุดพัก/ดำเนินงานต่อ

### 4.1 Pause Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                        PAUSE JOB FLOW                           │
└─────────────────────────────────────────────────────────────────┘

งาน (in_progress)
    │
    ├── ช่างต้องหยุดงานชั่วคราว
    │
    ├── เลือกเหตุผล:
    │   ├── waiting_parts     - รออะไหล่
    │   ├── waiting_approval  - รออนุมัติ
    │   ├── waiting_vendor    - รอผู้รับเหมา
    │   ├── customer_unavailable - ลูกค้าไม่อยู่
    │   ├── weather           - สภาพอากาศ
    │   └── other             - อื่นๆ
    │
    ├── กรอกรายละเอียด
    │
    └── ยืนยัน Pause
         │
         ├── บันทึก job_pauses:
         │   ├── paused_at = now
         │   ├── reason
         │   └── reason_category
         │
         ├── อัปเดต request:
         │   ├── is_paused = true
         │   └── pause_count++
         │
         └── แจ้งเตือน:
             ├── ผู้แจ้ง
             └── Admin
```

### 4.2 Resume Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                       RESUME JOB FLOW                           │
└─────────────────────────────────────────────────────────────────┘

งาน (paused)
    │
    ├── ช่างดำเนินงานต่อ
    │
    └── คลิก "ดำเนินการต่อ"
         │
         ├── คำนวณ pause_duration:
         │   └── now - paused_at
         │
         ├── อัปเดต job_pauses:
         │   ├── resumed_at = now
         │   └── pause_duration = คำนวณ
         │
         ├── ขยาย SLA:
         │   └── due_at = due_at + pause_duration
         │
         ├── อัปเดต request:
         │   └── is_paused = false
         │
         └── แจ้งเตือน:
             ├── ผู้แจ้ง
             └── Admin
```

---

## 5. Workflow การอนุมัติค่าใช้จ่าย

### 5.1 Approval Threshold

```
┌─────────────────────────────────────────────────────────────────┐
│                   APPROVAL THRESHOLD LEVELS                     │
└─────────────────────────────────────────────────────────────────┘

จำนวนเงิน
    │
    ├── Level 1 (0 - 5,000 บาท)
    │   └── ผู้อนุมัติ: Manager
    │
    ├── Level 2 (5,001 - 20,000 บาท)
    │   └── ผู้อนุมัติ: Admin
    │
    └── Level 3 (20,001+ บาท)
        └── ผู้อนุมัติ: Admin + CEO
```

### 5.2 Approval Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                      APPROVAL WORKFLOW                          │
└─────────────────────────────────────────────────────────────────┘

รายการค่าใช้จ่าย/ใบแจ้งหนี้
    │
    ├── ส่งอนุมัติ
    │   │
    │   ├── สร้าง approval_request
    │   │   ├── status = pending
    │   │   └── current_level = 1
    │   │
    │   └── แจ้งเตือน approver ระดับ 1
    │
    ├── ผู้อนุมัติ Level 1 พิจารณา
    │   │
    │   ├── อนุมัติ ──────────┐
    │   │                     │
    │   └── ปฏิเสธ            │
    │       │                 │
    │       └── บันทึก log    │
    │           ↓             │
    │        rejected         │
    │                         │
    │   ◄─────────────────────┘
    │   │
    │   ├── ถ้าต้องอนุมัติเพิ่ม:
    │   │   └── ส่งต่อ Level 2
    │   │
    │   └── ถ้าอนุมัติครบ:
    │       │
    │       ├── status = approved
    │       └── แจ้งเตือนผู้ส่ง
    │
    └── ดำเนินการจ่ายเงิน
```

---

## 6. Workflow ใบเบิกเงิน

### 6.1 Disbursement Status Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                   DISBURSEMENT WORKFLOW                         │
└─────────────────────────────────────────────────────────────────┘

     ┌──────────┐
     │  DRAFT   │  สร้างใบเบิก
     │   ร่าง    │
     └────┬─────┘
          │
          │ ส่งอนุมัติ
          ▼
    ┌──────────┐         ┌──────────┐
    │SUBMITTED │────────▶│ REJECTED │
    │ ส่งอนุมัติ │  ปฏิเสธ  │  ปฏิเสธ   │
    └────┬─────┘         └──────────┘
          │
          │ อนุมัติ
          ▼
    ┌──────────┐
    │PROCESSING│
    │กำลังดำเนินการ│
    └────┬─────┘
          │
          │ โอนเงินแล้ว
          ▼
    ┌──────────┐
    │   PAID   │
    │  จ่ายแล้ว  │
    └──────────┘
```

### 6.2 Document Number Generation

```
รูปแบบ: DB + YYMM + Sequence

ตัวอย่าง: DB2601001
    │
    ├── DB     - Prefix (Disbursement)
    ├── 26     - ปี (2026)
    ├── 01     - เดือน (มกราคม)
    └── 001    - ลำดับที่ในเดือน
```

---

## 7. Workflow การแจ้งเตือน

### 7.1 Notification Triggers

```
┌─────────────────────────────────────────────────────────────────┐
│                   NOTIFICATION TRIGGERS                         │
└─────────────────────────────────────────────────────────────────┘

Event                          │ Notification Type │ Recipients
───────────────────────────────┼───────────────────┼──────────────
งานใหม่                         │ assignment        │ Admin
มอบหมายงาน                      │ assignment        │ ช่าง
SLA Warning (75%)              │ sla_warning       │ ช่าง
SLA Critical (90%)             │ sla_warning       │ ช่าง, Admin
SLA Breached (100%)            │ sla_warning       │ ทุกคน
สถานะเปลี่ยน                    │ status_change     │ ผู้แจ้ง, Admin
ข้อความแชทใหม่                  │ chat              │ ผู้ที่ไม่ใช่ผู้ส่ง
งานบำรุงรักษาตามกำหนด           │ scheduled         │ ช่าง
รออนุมัติ                       │ approval_required │ Approver
อนุมัติแล้ว                     │ approval_approved │ ผู้ส่ง
ปฏิเสธ                         │ approval_rejected │ ผู้ส่ง
พร้อมจ่ายเงิน                   │ disbursement_ready│ ผู้รับเงิน
```

### 7.2 Notification Flow

```
Event เกิดขึ้น
    │
    ├── ระบุประเภท notification
    │
    ├── ระบุผู้รับ
    │
    ├── สร้าง notification record:
    │   ├── user_id
    │   ├── type
    │   ├── title
    │   ├── message
    │   ├── request_id (ถ้ามี)
    │   └── is_read = false
    │
    └── Real-time push (Supabase Realtime)
        │
        └── แสดงที่ NotificationBell
```

---

## 8. Workflow ตารางบำรุงรักษา

### 8.1 Scheduled Maintenance Flow

```
┌─────────────────────────────────────────────────────────────────┐
│               SCHEDULED MAINTENANCE WORKFLOW                    │
└─────────────────────────────────────────────────────────────────┘

Admin สร้างตาราง
    │
    ├── กำหนด:
    │   ├── ชื่อรายการ
    │   ├── ประเภท
    │   ├── ความถี่ (ทุก N วัน)
    │   ├── สาขา
    │   ├── ช่างที่รับผิดชอบ
    │   └── ความสำคัญ
    │
    └── บันทึก
         │
         ├── คำนวณ next_due
         └── เริ่มกำหนดการ

ทุกวัน (cron job)
    │
    ├── ตรวจสอบ schedules ที่ next_due <= วันนี้
    │
    └── สำหรับแต่ละ schedule:
         │
         ├── สร้าง maintenance_request อัตโนมัติ
         │   ├── title จาก schedule
         │   ├── priority จาก schedule
         │   ├── assigned_user จาก schedule
         │   └── branch จาก schedule
         │
         ├── อัปเดต schedule:
         │   ├── last_generated = now
         │   └── next_due = now + frequency_days
         │
         └── แจ้งเตือนช่าง
```

---

## 9. Workflow การตรวจจับปัญหาซ้ำ

### 9.1 Incident Detection Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                  INCIDENT DETECTION FLOW                        │
└─────────────────────────────────────────────────────────────────┘

เมื่อสร้าง request ใหม่
    │
    ├── ค้นหา requests ที่คล้ายกัน (30 วันย้อนหลัง)
    │
    ├── คำนวณ similarity score:
    │   ├── สาขาเดียวกัน:  +0.30
    │   ├── ประเภทเดียวกัน: +0.30
    │   ├── อุปกรณ์เดียวกัน: +0.25
    │   └── ข้อความคล้ายกัน: +0.15
    │
    ├── ถ้า score >= 0.6:
    │   │
    │   ├── แสดง "Incident Alert" ในหน้า request
    │   │
    │   └── แนะนำให้เชื่อมโยงกับ incident
    │
    └── ถ้าไม่มี:
        └── ไม่ต้องทำอะไร
```

### 9.2 Incident Creation Flow

```
Admin ตรวจพบปัญหาซ้ำ
    │
    ├── สร้าง Incident:
    │   ├── ชื่อ incident
    │   ├── รายละเอียด
    │   ├── severity (low/medium/high/critical)
    │   └── status = open
    │
    ├── เชื่อมโยง requests ที่เกี่ยวข้อง
    │   └── incident_requests (many-to-many)
    │
    └── ติดตาม:
        ├── open → investigating → resolved → closed
        └── root_cause, resolution
```

---

## สรุป Key Workflows

### Critical Path: การแจ้งซ่อม
```
สร้างคำขอ → Pending → Assigned → In Progress → Completed
    └── SLA tracking ตลอดทาง
    └── แจ้งเตือนทุกขั้นตอน
```

### Financial Path: ค่าใช้จ่าย
```
บันทึกค่าใช้จ่าย → ส่งอนุมัติ → อนุมัติ → สร้างใบเบิก → จ่ายเงิน
    └── Threshold-based approval
```

### Preventive Path: บำรุงรักษา
```
สร้างตาราง → Auto-generate requests → ช่างดำเนินการ → เสร็จ → วนรอบ
```

---

## Appendix: Database Tables Reference

| Table | Purpose |
|-------|---------|
| `maintenance_requests` | งานแจ้งซ่อม |
| `profiles` | ผู้ใช้งาน |
| `branches` | สาขา |
| `branch_working_hours` | เวลาทำการสาขา |
| `holidays` | วันหยุด |
| `equipment` | อุปกรณ์ |
| `vendors` | ผู้รับเหมา |
| `status_logs` | ประวัติสถานะ |
| `job_pauses` | ประวัติหยุดพักงาน |
| `notifications` | การแจ้งเตือน |
| `cost_logs` | บันทึกค่าใช้จ่าย |
| `vendor_invoices` | ใบแจ้งหนี้ |
| `expense_records` | บันทึกค่าใช้จ่ายโดยตรง |
| `disbursement_requests` | ใบเบิกเงิน |
| `approval_requests` | คำขออนุมัติ |
| `approval_logs` | ประวัติการอนุมัติ |
| `maintenance_schedules` | ตารางบำรุงรักษา |
| `incidents` | ปัญหาซ้ำ |
| `technician_skills` | ทักษะช่าง |
| `technician_availability` | ความพร้อมช่าง |
| `assignment_rules` | กฎการมอบหมายงาน |

---

*เอกสารนี้อัปเดตล่าสุด: มกราคม 2026*
